<!DOCTYPE html>
<html lang="en">
	<head>
		<meta charset="utf-8">

		<link rel="stylesheet" href="https://maxcdn.bootstrapcdn.com/bootstrap/4.0.0/css/bootstrap.min.css" integrity="sha384-Gn5384xqQ1aoWXA+058RXPxPg6fy4IWvTNh0E263XmFcJlSAwiGgFAW/dAiS6JXm" crossorigin="anonymous">
	</head>
	<body>
		<div class="container-fluid">
			<div class="row">
				<table class="table table-striped table-hover table-sm table-bordered">
					<thead>
						<tr>
							<th>Mac Address</th>
							<th>Alias</th>
							<th>Ult. comunicación</th>
							<th>SSID</th>
							<th>RSSI</th>
							<th>Ubicación</th>
							<th>Precisión</th>
							<th>En movimiento</th>
							<th>Tiempo sin movimiento</th>
							<th>Estado Batería</th>
						</tr>
					</thead>

					<tbody></tbody>
				</table>
			</div>
		</div>
	</body>

	<script src="/socket.io/socket.io.js"></script>
	<script src="https://code.jquery.com/jquery-3.3.1.min.js" integrity="sha256-FgpCb/KJQlLNfOu91ta32o/NMZxltwRo8QtmkMRdAu8=" crossorigin="anonymous"></script>
	
	<script type="text/javascript">

		var socket = io.connect();
		var tbody = $('tbody');

		socket.on('accelData', function(accelData) {
			tbody.empty();

			accelData.forEach((deviceData) => {
console.log(deviceData);
				var macAddress = deviceData.serial.split(':').join('_')
				var deviceRow = $('tr#' + macAddress)

				newRow(macAddress);
				updateRow($('tr#' + macAddress), deviceData);
			});
		});

		function updateRow(deviceRow, data) {
			deviceRow.children(".alias").text(data.alias);

			lastComunication = new Date(data.ultimaTransmision);

			/**
			 * timezone correction
			 */
			lastComunication.setHours(lastComunication.getHours());

			deviceRow.children(".last-comunication").text(
				`${('0'+lastComunication.getDate()).substr(-2)}-${('0'+(lastComunication.getMonth()+1)).substr(-2)}-${lastComunication.getFullYear()}`
				+ ` ${lastComunication.getHours()}:${('0'+lastComunication.getMinutes()).substr(-2)}:${('0'+lastComunication.getSeconds()).substr(-2)}`
			);

			deviceRow.children(".SSID").text(data.wifi.ssid);
			deviceRow.children(".RSSI").text(data.wifi.intensidad);

			const mapsLink = document.createElement('a');
			mapsLink.appendChild(document.createTextNode('Maps'));
			mapsLink.title = 'Maps';
			mapsLink.target = '_blank';
			mapsLink.href = 'https://www.google.com/maps/@'+data.geoposicion.lat+','+data.geoposicion.lon+',16z'

			deviceRow.children(".location").html(mapsLink);
			deviceRow.children(".accuracy").text(data.geoposicion.accuracy);

			if (data.enMovimiento) {
				deviceRow.children(".in-movement").removeClass('bg-danger').addClass('bg-success');
			} else {
				deviceRow.children(".in-movement").removeClass('bg-success').addClass('bg-danger');
			}

			deviceRow.children(".seconds-no-movement").text(data.tiempoQuieto + ' segundos');

			deviceRow.children(".battery").text(data.bateria + ' %');
		}

		function newRow(macAddress) {
			var newRow = '<tr id=' + macAddress + '>'
					+ '<td>' + macAddress.split('_').join(':') + '</td>'
					+ '<td class=\"alias\""></td>'
					+ '<td class=\"last-comunication\"></td>'
					+ '<td class=\"SSID\"></td>'
					+ '<td class=\"RSSI\"></td>'
					+ '<td class=\"location\"></td>'
					+ '<td class=\"accuracy\"></td>'
					+ '<td class=\"in-movement\"></td>'
					+ '<td class=\"seconds-no-movement\"></td>'
					+ '<td class=\"battery\">83%</td>'
				+ '</tr\>';

			$('tbody').append(newRow);
		}

	</script>
</html>
