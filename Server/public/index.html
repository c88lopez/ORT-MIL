<!DOCTYPE html>
<html lang="en">
	<head>
		<meta charset="utf-8">

		<link rel="stylesheet" href="https://maxcdn.bootstrapcdn.com/bootstrap/4.0.0/css/bootstrap.min.css" integrity="sha384-Gn5384xqQ1aoWXA+058RXPxPg6fy4IWvTNh0E263XmFcJlSAwiGgFAW/dAiS6JXm" crossorigin="anonymous">
	</head>
	<body>
		<div class="container-fluid">
			<div class="row">
				<table class="table table-striped table-hover table-sm">
					<thead>
						<tr>
							<th>Mac Address</th>
							<th>Alias</th>
							<th>Ult. comunicación</th>
							<th>SSID</th>
							<th>RSSI</th>
							<th>Latitud</th>
							<th>Longitud</th>
							<th>Precisión</th>
							<th>En movimiento</th>
							<th>Estado Batería</th>
						</tr>
					</thead>

					<tbody></tbody>
				</table>
			</div>
		</div>
	</body>

	<script src="/socket.io/socket.io.js"></script>
	<script src="https://code.jquery.com/jquery-3.3.1.min.js" integrity="sha256-FgpCb/KJQlLNfOu91ta32o/NMZxltwRo8QtmkMRdAu8=" crossorigin="anonymous"></script>
	
	<script type="text/javascript">

		var socket = io.connect();

		socket.on('accelData', function(accelData) {
			var macAddress = accelData.data.macAddress.split(':').join('_')
			
			var deviceRow = $('tr#' + macAddress)

			if (deviceRow.length === 1) {
				updateRow(deviceRow, accelData.data);
			} else {
				newRow(macAddress)
				updateRow($('tr#' + macAddress), accelData.data)
			}
		});

		function updateRow(deviceRow, data) {
			lastComunication = new Date(data.currentTime);

			deviceRow.children(".alias").text(data.alias);

			deviceRow.children(".last-comunication").text(
				`${('0'+lastComunication.getDate()).substr(-2)}-${('0'+lastComunication.getMonth()).substr(-2)}-${lastComunication.getFullYear()}`
				+ ` ${lastComunication.getHours()}:${('0'+lastComunication.getMinutes()).substr(-2)}:${('0'+lastComunication.getSeconds()).substr(-2)}`
			);

			deviceRow.children(".SSID").text(data.SSID);
			deviceRow.children(".RSSI").text(data.RSSI);
			deviceRow.children(".lat").text(data.position.latitude);
			deviceRow.children(".lon").text(data.position.longitude);
			deviceRow.children(".accuracy").text(data.position.accuracy);

			if (data.isMoving) {
				deviceRow.children(".in-movement").removeClass('bg-danger').addClass('bg-success');
			} else {
				deviceRow.children(".in-movement").removeClass('bg-success').addClass('bg-danger');
			}

			deviceRow.children(".battery").text(data.battery + '%');
		}

		function newRow(macAddress) {
			var newRow = '<tr id=' + macAddress + '>'
					+ '<td>' + macAddress.split('_').join(':') + '</td>'
					+ '<td class=\"alias\""></td>'
					+ '<td class=\"last-comunication\"></td>'
					+ '<td class=\"SSID\"></td>'
					+ '<td class=\"RSSI\"></td>'
					+ '<td class=\"lat\"></td>'
					+ '<td class=\"lon\"></td>'
					+ '<td class=\"accuracy\"></td>'
					+ '<td class=\"in-movement\"></td>'
					+ '<td class=\"battery\">83%</td>'
				+ '</tr\>';

			$('tbody').append(newRow);
		}

	</script>
</html>
